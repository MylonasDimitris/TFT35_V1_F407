#include "TFT_UI.h"

// The Standard 5x7 ASCII Font 
const uint8_t font5x7[] = {
    0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x5F,0x00,0x00, 0x00,0x07,0x00,0x07,0x00, 0x14,0x7F,0x14,0x7F,0x14,
    0x24,0x2A,0x7F,0x2A,0x12, 0x23,0x13,0x08,0x64,0x62, 0x36,0x49,0x55,0x22,0x50, 0x00,0x05,0x03,0x00,0x00,
    0x00,0x1C,0x22,0x41,0x00, 0x00,0x41,0x22,0x1C,0x00, 0x08,0x2A,0x1C,0x2A,0x08, 0x08,0x08,0x3E,0x08,0x08,
    0x00,0x50,0x30,0x00,0x00, 0x08,0x08,0x08,0x08,0x08, 0x00,0x60,0x60,0x00,0x00, 0x20,0x10,0x08,0x04,0x02,
    0x3E,0x51,0x49,0x45,0x3E, 0x00,0x42,0x7F,0x40,0x00, 0x42,0x61,0x51,0x49,0x46, 0x21,0x41,0x45,0x4B,0x31,
    0x18,0x14,0x12,0x7F,0x10, 0x27,0x45,0x45,0x45,0x39, 0x3C,0x4A,0x49,0x49,0x30, 0x01,0x71,0x09,0x05,0x03,
    0x36,0x49,0x49,0x49,0x36, 0x06,0x49,0x49,0x29,0x1E, 0x00,0x36,0x36,0x00,0x00, 0x00,0x56,0x36,0x00,0x00,
    0x00,0x08,0x14,0x22,0x41, 0x14,0x14,0x14,0x14,0x14, 0x41,0x22,0x14,0x08,0x00, 0x02,0x01,0x51,0x09,0x06,
    0x32,0x49,0x79,0x41,0x3E, 0x7E,0x11,0x11,0x11,0x7E, 0x7F,0x49,0x49,0x49,0x36, 0x3E,0x41,0x41,0x41,0x22,
    0x7F,0x41,0x41,0x22,0x1C, 0x7F,0x49,0x49,0x49,0x41, 0x7F,0x09,0x09,0x01,0x01, 0x3E,0x41,0x41,0x51,0x32,
    0x7F,0x08,0x08,0x08,0x7F, 0x00,0x41,0x7F,0x41,0x00, 0x20,0x40,0x41,0x3F,0x01, 0x7F,0x08,0x14,0x22,0x41,
    0x7F,0x40,0x40,0x40,0x40, 0x7F,0x02,0x04,0x02,0x7F, 0x7F,0x04,0x08,0x10,0x7F, 0x3E,0x41,0x41,0x41,0x3E,
    0x7F,0x09,0x09,0x09,0x06, 0x3E,0x41,0x51,0x21,0x5E, 0x7F,0x09,0x19,0x29,0x46, 0x46,0x49,0x49,0x49,0x31,
    0x01,0x01,0x7F,0x01,0x01, 0x3F,0x40,0x40,0x40,0x3F, 0x1F,0x20,0x40,0x20,0x1F, 0x7F,0x20,0x18,0x20,0x7F,
    0x63,0x14,0x08,0x14,0x63, 0x03,0x04,0x78,0x04,0x03, 0x61,0x51,0x49,0x45,0x43, 0x00,0x7F,0x41,0x41,0x00,
    0x02,0x04,0x08,0x10,0x20, 0x00,0x41,0x41,0x7F,0x00, 0x04,0x02,0x01,0x02,0x04, 0x40,0x40,0x40,0x40,0x40,
    0x00,0x01,0x02,0x04,0x00, 0x20,0x54,0x54,0x54,0x78, 0x7F,0x48,0x44,0x44,0x38, 0x38,0x44,0x44,0x44,0x20,
    0x38,0x44,0x44,0x48,0x7F, 0x38,0x54,0x54,0x54,0x18, 0x08,0x7E,0x09,0x01,0x02, 0x08,0x14,0x54,0x54,0x3C,
    0x7F,0x08,0x04,0x04,0x78, 0x00,0x44,0x7D,0x40,0x00, 0x20,0x40,0x44,0x3D,0x00, 0x7F,0x10,0x28,0x44,0x00,
    0x00,0x41,0x7F,0x40,0x00, 0x7C,0x04,0x18,0x04,0x78, 0x7C,0x08,0x04,0x04,0x78, 0x38,0x44,0x44,0x44,0x38,
    0x7C,0x14,0x14,0x14,0x08, 0x08,0x14,0x14,0x18,0x7C, 0x7C,0x08,0x04,0x04,0x08, 0x48,0x54,0x54,0x54,0x20,
    0x04,0x3F,0x44,0x40,0x20, 0x3C,0x40,0x40,0x20,0x7C, 0x1C,0x20,0x40,0x20,0x1C, 0x3C,0x40,0x30,0x40,0x3C,
    0x44,0x28,0x10,0x28,0x44, 0x0C,0x50,0x50,0x50,0x3C, 0x44,0x64,0x54,0x4C,0x44, 0x00,0x08,0x36,0x41,0x00,
    0x00,0x00,0x7F,0x00,0x00, 0x00,0x41,0x36,0x08,0x00, 0x08,0x08,0x2A,0x1C,0x08
};

// --- UI ENGINE IMPLEMENTATION ---

TFT_UI::TFT_UI(TFT35_V1_F407* tft) {
    _tft = tft;
}

void TFT_UI::fillRect(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color) {
    if (!_tft) return;
    if (x >= 480 || y >= 320) return;
    if (x + w > 480) w = 480 - x;
    if (y + h > 320) h = 320 - y;

    _tft->setWindow(x, y, x + w - 1, y + h - 1); 
    uint32_t totalPixels = w * h;
    for(uint32_t i = 0; i < totalPixels; i++) {
        LCD_DAT = color;
    }
}

void TFT_UI::drawChar(uint16_t x, uint16_t y, char c, uint16_t color, uint16_t bg, uint8_t size) {
    if (c < 32 || c > 127) return; // Keep inside ASCII limits
    uint8_t fontIndex = c - 32;

    for (int8_t i = 0; i < 5; i++) { // Char width is 5 pixels
        uint8_t line = font5x7[fontIndex * 5 + i];
        for (int8_t j = 0; j < 8; j++, line >>= 1) { // Char height is 8 pixels
            if (line & 1) {
                if (size == 1) fillRect(x + i, y + j, 1, 1, color);
                else fillRect(x + i * size, y + j * size, size, size, color);
            } else if (bg != color) {
                if (size == 1) fillRect(x + i, y + j, 1, 1, bg);
                else fillRect(x + i * size, y + j * size, size, size, bg);
            }
        }
    }
}

void TFT_UI::drawString(uint16_t x, uint16_t y, const char* text, uint16_t color, uint16_t bg, uint8_t size) {
    while (*text) {
        drawChar(x, y, *text, color, bg, size);
        x += (5 * size) + (1 * size); // Move cursor to the next character (+1 pixel spacing)
        text++;
    }
}

// --- BUTTON CLASS IMPLEMENTATION ---

TFT_Button::TFT_Button() {
    _ui = nullptr;
    _action = nullptr;
    _lastPressTime = 0;
}

void TFT_Button::init(TFT_UI* ui, uint16_t x, uint16_t y, uint16_t w, uint16_t h, 
                      uint16_t color, uint16_t textColor, const char* label, ButtonCallback callback) {
    _ui = ui;
    _x = x; _y = y; _w = w; _h = h;
    _color = color; _textColor = textColor;
    _label = label;
    _action = callback;
}

void TFT_Button::draw() {
    if (!_ui) return;

    // Draw the button background
    _ui->fillRect(_x, _y, _w, _h, _color);

    // Calculate text centering 
    uint8_t textSize = 3;
    uint16_t textWidth = 0;
    const char* c = _label;
    while (*c) { textWidth += (6 * textSize); c++; } // 5 px width + 1 px space
    
    uint16_t textX = _x + (_w - textWidth) / 2;
    uint16_t textY = _y + (_h - (8 * textSize)) / 2; // 8 px height

    // Draw the label
    _ui->drawString(textX, textY, _label, _textColor, _color, textSize);
}

bool TFT_Button::checkTouch(uint16_t touchX, uint16_t touchY) {
    if (touchX >= _x && touchX <= (_x + _w) && touchY >= _y && touchY <= (_y + _h)) {
        if (millis() - _lastPressTime > 250) { // Debounce
            _lastPressTime = millis();
            if (_action != nullptr) {
                _action(); 
            }
            return true;
        }
    }
    return false;
}